@page "/calendar"
@layout TestLayout

@inject PinAuthService Auth
@inject ICalendarService CalendarService
@inject NavigationManager Nav

<!-- ===============================
     CALENDAR PAGE
     =============================== -->
<div class="calendar-page">

    <!-- ===============================
         MONTH VIEW CALENDAR CARD
         =============================== -->
    <div class="calendar-card tall-calendar">

        <!-- MONTH NAVIGATION HEADER -->
        <div class="calendar-header">
            <span class="arrow" @onclick="PrevMonth">‚Äπ</span>
            <h3>@CurrentMonthName @CurrentYear</h3>
            <span class="arrow" @onclick="NextMonth">‚Ä∫</span>
        </div>

        <!-- WEEKDAY LABELS -->
        <div class="weekdays">
            <span>S</span><span>M</span><span>T</span>
            <span>W</span><span>T</span><span>F</span><span>S</span>
        </div>

        <!-- CALENDAR GRID -->
        <div class="days">
            @foreach (var day in CalendarDays)
            {
                <!-- Placeholder cells for alignment -->
                if (day.Date == DateTime.MinValue)
                {
                    <div class="day empty"></div>
                }
                else
                {
                    <!-- Individual day cell -->
                    <div class="day
                        @(day.HasEntry ? "has-entry" : "")
                        @(day.IsToday ? "today" : "")
                        @(!day.HasEntry && !day.IsToday ? "disabled" : "")"
                         @onclick="() => OpenDay(day)">

                        <!-- Day number -->
                        @day.Date.Day

                        <!-- Mood indicator dot -->
                        @if (!string.IsNullOrEmpty(day.MoodType))
                        {
                            <span class="calendar-dot @day.MoodType"></span>
                        }
                    </div>
                }
            }
        </div>

        <!-- MOOD LEGEND -->
        <div class="legend">
            <div class="legend-item">
                <span class="legend-dot positive"></span> Positive
            </div>
            <div class="legend-item">
                <span class="legend-dot neutral"></span> Neutral
            </div>
            <div class="legend-item">
                <span class="legend-dot negative"></span> Negative
            </div>
        </div>

        <p class="hint">
            Click a date to view or write a journal entry
        </p>
    </div>

    <!-- ===============================
         YEAR SUMMARY CARD
         =============================== -->
    <div class="year-card">
        <h2>@CurrentYear</h2>
        <div class="year-image">
            <img src="/images/flower.png" alt="Year illustration" />
        </div>
        <p class="year-caption">
            Year overview of journal entries
        </p>
    </div>

    <!-- ===============================
         RIGHT SIDEBAR
         =============================== -->
    <div class="right-column">

        <!-- TODAY STATUS CARD -->
        <div class="today-card">
            <div class="today-header">
                <div class="today-icon">üìÖ</div>
                <h3>Today</h3>
            </div>

            <div class="today-status">
                <span class="status-dot @(TodayEntry != null ? "positive" : "negative")"></span>
                @(TodayEntry != null
                    ? "Today‚Äôs entry written"
                    : "Today‚Äôs entry not written")
            </div>

            <!-- Shortcut to today‚Äôs journal -->
            <button class="today-btn" @onclick="GoToToday">
                ‚úçÔ∏è @(TodayEntry != null
                    ? "Edit Today‚Äôs Entry"
                    : "Write Today‚Äôs Entry")
            </button>
        </div>

        <!-- MISSED DAYS CARD -->
        <div class="missed-card">
            <div class="missed-header">
                <div class="missed-icon">üìÜ</div>
                <h3>Missed Days</h3>
            </div>

            @if (!MissedDays.Any())
            {
                <p class="hint">No missed days üéâ</p>
            }
            else
            {
                @foreach (var date in MissedDays)
                {
                    <div class="missed-item">
                        <span class="missed-dot"></span>
                        @date.ToString("MMM dd, yyyy")
                    </div>
                }
            }
        </div>

    </div>

</div>

@code {

    // ===============================
    // STATE
    // ===============================

    /// <summary>
    /// Collection representing the 6√ó7 calendar grid.
    /// Includes placeholder cells for alignment.
    /// </summary>
    private List<CalendarDayModel> CalendarDays = new();

    /// <summary>
    /// Journal entry corresponding to today, if it exists.
    /// </summary>
    private CalendarDayModel? TodayEntry;

    /// <summary>
    /// List of past dates in the current month
    /// where no journal entry was written.
    /// </summary>
    private List<DateTime> MissedDays = new();

    private int CurrentYear = DateTime.Today.Year;
    private int CurrentMonth = DateTime.Today.Month;

    /// <summary>
    /// Display-friendly month name (e.g., January).
    /// </summary>
    private string CurrentMonthName =>
        new DateTime(CurrentYear, CurrentMonth, 1).ToString("MMMM");

    // ===============================
    // LIFECYCLE
    // ===============================

    /// <summary>
    /// Ensures authentication and loads
    /// calendar data on page initialization.
    /// </summary>
    protected override async Task OnInitializedAsync()
    {
        // üîê Authentication guard
        if (!Auth.IsUnlocked)
        {
            Nav.NavigateTo("/", replace: true);
            return;
        }

        await LoadToday();
        await LoadCalendar();
    }

    // ===============================
    // DATA LOADING
    // ===============================

    /// <summary>
    /// Builds the monthly calendar grid and
    /// calculates missed days.
    /// </summary>
    private async Task LoadCalendar()
    {
        CalendarDays.Clear();

        var firstDay = new DateTime(CurrentYear, CurrentMonth, 1);
        var daysInMonth = DateTime.DaysInMonth(CurrentYear, CurrentMonth);
        int startOffset = (int)firstDay.DayOfWeek;

        var monthData = await CalendarService.GetMonthAsync(CurrentYear, CurrentMonth);

        // Leading placeholder cells
        for (int i = 0; i < startOffset; i++)
        {
            CalendarDays.Add(new CalendarDayModel
            {
                Date = DateTime.MinValue
            });
        }

        // Actual calendar days
        for (int d = 1; d <= daysInMonth; d++)
        {
            var date = new DateTime(CurrentYear, CurrentMonth, d);
            var entry = monthData.FirstOrDefault(e => e.Date.Date == date.Date);

            CalendarDays.Add(new CalendarDayModel
            {
                Date = date,
                IsToday = date.Date == DateTime.Today,
                HasEntry = entry != null,
                JournalId = entry?.JournalId,
                MoodType = entry?.MoodType
            });
        }

        // Trailing placeholders to maintain 42 cells
        while (CalendarDays.Count < 42)
        {
            CalendarDays.Add(new CalendarDayModel
            {
                Date = DateTime.MinValue
            });
        }

        // Identify missed days (past only)
        MissedDays = CalendarDays
            .Where(d =>
                d.Date != DateTime.MinValue &&
                d.Date < DateTime.Today &&
                d.Date.Month == CurrentMonth &&
                d.Date.Year == CurrentYear &&
                !d.HasEntry)
            .Select(d => d.Date)
            .ToList();
    }

    /// <summary>
    /// Loads today's journal entry, if present.
    /// </summary>
    private async Task LoadToday()
    {
        var todayMonth = await CalendarService.GetMonthAsync(
            DateTime.Today.Year,
            DateTime.Today.Month);

        TodayEntry = todayMonth.FirstOrDefault(d =>
            d.Date.Date == DateTime.Today && d.HasEntry);
    }

    // ===============================
    // NAVIGATION LOGIC
    // ===============================

    /// <summary>
    /// Handles calendar day clicks:
    /// - Opens journal detail if entry exists
    /// - Opens editor if today has no entry
    /// - Ignores past empty dates
    /// </summary>
    private void OpenDay(CalendarDayModel day)
    {
        // Ignore placeholder cells
        if (day.Date == DateTime.MinValue)
            return;

        // Entry exists ‚Üí open detail view
        if (day.HasEntry && day.JournalId.HasValue)
        {
            Nav.NavigateTo($"/journal/{day.JournalId.Value}");
            return;
        }

        // Today with no entry ‚Üí open editor
        if (day.IsToday)
        {
            Nav.NavigateTo("/journaltoday");
            return;
        }

        // Past date with no entry ‚Üí do nothing
    }

    /// <summary>
    /// Navigates to today's journal entry or editor.
    /// </summary>
    private void GoToToday()
    {
        if (TodayEntry != null)
            Nav.NavigateTo($"/journaltoday/{TodayEntry.JournalId}");
        else
            Nav.NavigateTo("/journaltoday");
    }

    /// <summary>
    /// Navigates to the previous month.
    /// </summary>
    private async Task PrevMonth()
    {
        if (--CurrentMonth == 0)
        {
            CurrentMonth = 12;
            CurrentYear--;
        }
        await LoadCalendar();
    }

    /// <summary>
    /// Navigates to the next month.
    /// </summary>
    private async Task NextMonth()
    {
        if (++CurrentMonth == 13)
        {
            CurrentMonth = 1;
            CurrentYear++;
        }
        await LoadCalendar();
    }
}
