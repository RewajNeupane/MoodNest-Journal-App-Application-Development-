@page "/journaltoday"
@page "/journaltoday/{Id:int}"
@layout TestLayout

@inject IJSRuntime _js
@inject IJournalService JournalService
@inject NavigationManager Nav

<div class="journal-editor-page">

    <!-- LEFT META PANEL -->
    <aside class="entry-sidebar">

        <button class="new-btn"
                disabled="@HasTodayEntry"
                title="You can only write one journal entry per day"
                @onclick="NewEntry">
            Ôºã New Entry
        </button>


        <!-- TODAY -->
        <div class="entry-meta">
            <h4>Today</h4>
            <p class="meta-date">@TodayLabel</p>
        </div>

        <!-- PRIMARY MOOD -->
        <div class="entry-meta">
            <h4>Primary Mood *</h4>
            <div class="mood-list">
                @foreach (var mood in PrimaryMoodOptions)
                {
                    <span class="pill mood @(PrimaryMood == mood ? "active" : "")"
                          @onclick="() => PrimaryMood = mood">
                        @mood
                    </span>
                }
            </div>
        </div>

        <!-- SECONDARY MOODS -->
        <div class="entry-meta">
            <h4>Secondary Moods</h4>
            <div class="mood-list subtle">
                @foreach (var mood in SecondaryMoodOptions)
                {
                    <span class="pill mood
                          @(SecondaryMoods.Contains(mood) ? "active" : "")
                          @(SecondaryMoods.Count == 2 && !SecondaryMoods.Contains(mood) ? "disabled" : "")"
                          @onclick="() => ToggleSecondaryMood(mood)">
                        @mood
                    </span>
                }
            </div>
            <p class="hint">Up to 2 moods</p>
        </div>
        
        <!-- CATEGORY -->
        <div class="entry-meta">
            <h4>Category</h4>

            <select class="dropdown" @bind="SelectedCategoryMode">
                @foreach (var cat in Categories)
                {
                    <option value="@cat">@cat</option>
                }
                <option value="__custom">Ôºã Custom category‚Ä¶</option>
            </select>

            @if (SelectedCategoryMode == "__custom")
            {
                <input class="custom-category-input"
                       placeholder="Enter custom category‚Ä¶"
                       @bind="CustomCategory"
                       @bind:event="oninput" />
            }
        </div>


        <!-- TAGS -->
        <div class="entry-meta">
            <h4>Tags</h4>

            <div class="tags preset-tags">
                @foreach (var tag in PresetTags)
                {
                    <span class="pill tag @(SelectedTags.Contains(tag) ? "active" : "")"
                          @onclick="() => ToggleTag(tag)">
                        @tag
                    </span>
                }
            </div>

            <input class="tag-input"
                   placeholder="Add custom tag‚Ä¶"
                   @bind="CustomTag"
                   @onkeyup="HandleCustomTag" />
        </div>

        <!-- TIMESTAMPS -->
        <div class="entry-meta timestamps">
            <p>Created: @CreatedAt.ToString("dd/MM/yyyy ¬∑ HH:mm")</p>
            <p>Updated: @UpdatedAt.ToString("dd/MM/yyyy ¬∑ HH:mm")</p>
        </div>

    </aside>

    <!-- MAIN EDITOR -->
    <main class="editor-container">

        <div id="editor" class="editor-canvas quill-fix"></div>

        <div class="editor-actions">
            <button class="primary" @onclick="SaveEntry">
                @(IsEdit ? "Update Entry" : "Save Entry")
            </button>

            @if (IsEdit)
            {
                <button class="danger" @onclick="DeleteEntry">Delete</button>
            }
        </div>

    </main>

</div>

@code {
    
    private bool HasTodayEntry;


    /* =======================
       ROUTE / MODE
    ======================== */

    [Parameter] public int? Id { get; set; }
    private bool IsEdit => Id.HasValue;

    /* =======================
       STATE
    ======================== */

    private string PrimaryMood = "üòä Happy";
    private HashSet<string> SecondaryMoods = new();

    private string SelectedCategoryMode = "Personal";
    private string CustomCategory = string.Empty;


    private HashSet<string> SelectedTags = new();
    private string CustomTag = string.Empty;

    private DateTime CreatedAt = DateTime.Now;
    private DateTime UpdatedAt = DateTime.Now;

    private string TodayLabel => DateTime.Now.ToString("dddd, MMMM dd");

    /* =======================
       OPTIONS
    ======================== */

    private readonly string[] PrimaryMoodOptions =
    {
        "üòä Happy", "üòå Calm", "üòê Neutral", "üòî Sad", "üò† Angry"
    };

    private readonly string[] SecondaryMoodOptions =
    {
        "üò¥ Tired", "üò¨ Anxious", "ü§î Thoughtful", "üòÑ Excited"
    };

    private readonly string[] Categories =
    {
        "Personal", "Work", "Health", "Relationships", "Reflection"
    };

    private readonly string[] PresetTags =
    {
        "#Work", "#Career", "#Studies", "#Family", "#Friends",
        "#Health", "#Fitness", "#Reflection", "#Writing",
        "#SelfCare", "#Travel"
    };

    /* =======================
       LIFECYCLE
    ======================== */

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;

        await _js.InvokeVoidAsync("initQuill", "editor");

        if (!IsEdit) return;

        var result = await JournalService.GetByIdAsync(Id!.Value);
        if (!result.Success || result.Data == null) return;

        var model = result.Data;

        PrimaryMood = model.PrimaryMood;
        
        if (Categories.Contains(model.Category))
        {
            SelectedCategoryMode = model.Category;
            CustomCategory = string.Empty;
        }
        else
        {
            SelectedCategoryMode = "__custom";
            CustomCategory = model.Category;
        }


        SecondaryMoods = string.IsNullOrWhiteSpace(model.SecondaryMoods)
            ? new()
            : model.SecondaryMoods.Split(',').ToHashSet();

        SelectedTags = string.IsNullOrWhiteSpace(model.Tags)
            ? new()
            : model.Tags.Split(',').ToHashSet();

        CreatedAt = model.CreatedAt;
        UpdatedAt = model.UpdatedAt;

        // üî• FIXED: JS SIGNATURE MATCH
        await _js.InvokeVoidAsync(
            "setQuillContent",
            "editor",
            model.Title,
            model.ContentHtml
        );
    }

    /* =======================
       HELPERS
    ======================== */

    private void ToggleSecondaryMood(string mood)
    {
        if (SecondaryMoods.Contains(mood))
            SecondaryMoods.Remove(mood);
        else if (SecondaryMoods.Count < 2)
            SecondaryMoods.Add(mood);
    }

    private void ToggleTag(string tag)
    {
        if (SelectedTags.Contains(tag))
            SelectedTags.Remove(tag);
        else
            SelectedTags.Add(tag);
    }

    private void HandleCustomTag(KeyboardEventArgs e)
    {
        if (e.Key != "Enter") return;

        var tag = "#" + CustomTag.Trim().Replace(" ", "");
        if (!string.IsNullOrWhiteSpace(tag))
            SelectedTags.Add(tag);

        CustomTag = string.Empty;
    }

    private void NewEntry()
    {
        Nav.NavigateTo("/journaltoday", true);
    }

    /* =======================
       SAVE / DELETE
    ======================== */

    private async Task SaveEntry()
    {
        var title = await _js.InvokeAsync<string>("getQuillTitle", "editor");
        var bodyHtml = await _js.InvokeAsync<string>("getQuillBody", "editor");

        if (string.IsNullOrWhiteSpace(bodyHtml))
        {
            await _js.InvokeVoidAsync("alert", "Journal cannot be empty.");
            return;
        }

        var resolvedCategory =
            SelectedCategoryMode == "__custom"
                ? CustomCategory.Trim()
                : SelectedCategoryMode;

        if (string.IsNullOrWhiteSpace(resolvedCategory))
        {
            await _js.InvokeVoidAsync("alert", "Please enter a category.");
            return;
        }

        var model = new JournalEntryViewModel
        {
            Title = string.IsNullOrWhiteSpace(title) ? "Untitled Entry" : title,
            ContentHtml = bodyHtml,
            PrimaryMood = PrimaryMood,
            SecondaryMoods = string.Join(",", SecondaryMoods),
            Category = resolvedCategory,
            Tags = string.Join(",", SelectedTags)
        };
        
        if (!IsEdit)
        {
            var todayCheck = await JournalService.GetTodayAsync();
            if (todayCheck.Success && todayCheck.Data != null)
            {
                await _js.InvokeVoidAsync(
                    "alert",
                    "You already have a journal entry for today."
                );
                return;
            }
        }


        var result = IsEdit
            ? await JournalService.UpdateAsync(Id!.Value, model)
            : await JournalService.CreateAsync(model);

        if (!result.Success)
        {
            await _js.InvokeVoidAsync("alert", result.ErrorMessage);
            return;
        }

        UpdatedAt = DateTime.Now;

        await _js.InvokeVoidAsync("showSaveSuccess");
        await _js.InvokeVoidAsync("clearQuillContent", "editor");

        SecondaryMoods.Clear();
        SelectedTags.Clear();

        if (!IsEdit)
            Nav.NavigateTo("/journal");
    }

    private async Task DeleteEntry()
    {
        if (!Id.HasValue) return;

        var result = await JournalService.DeleteAsync(Id.Value);
        if (!result.Success) return;

        Nav.NavigateTo("/journal");
    }
    protected override async Task OnInitializedAsync()
    {
        // Editing existing entry is always allowed
        if (IsEdit)
            return;

        var todayResult = await JournalService.GetTodayAsync();

        if (todayResult.Success && todayResult.Data != null)
        {
            HasTodayEntry = true;

            // Redirect to today's existing entry
            Nav.NavigateTo($"/journaltoday/{todayResult.Data.Id}", replace: true);
        }
    }

}
