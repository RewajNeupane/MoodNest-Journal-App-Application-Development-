@page "/journaltoday"
@page "/journaltoday/{Id:int}"
@layout TestLayout
@inject IJSRuntime _js
@inject MoodNest.Data.AppDbContext Db
@inject NavigationManager Nav

<div class="journal-editor-page">

    <!-- LEFT META PANEL -->
    <aside class="entry-sidebar">

        <button class="new-btn" @onclick="NewEntry">ï¼‹ New Entry</button>

        <!-- TODAY -->
        <div class="entry-meta">
            <h4>Today</h4>
            <p class="meta-date">@TodayLabel</p>
        </div>

        <!-- PRIMARY MOOD -->
        <div class="entry-meta">
            <h4>Primary Mood *</h4>
            <div class="mood-list">
                @foreach (var mood in PrimaryMoodOptions)
                {
                    <span class="pill mood @(PrimaryMood == mood ? "active" : "")"
                          @onclick="() => PrimaryMood = mood">
                        @mood
                    </span>
                }
            </div>
        </div>

        <!-- SECONDARY MOODS -->
        <div class="entry-meta">
            <h4>Secondary Moods</h4>
            <div class="mood-list subtle">
                @foreach (var mood in SecondaryMoodOptions)
                {
                    <span class="pill mood
                          @(SecondaryMoods.Contains(mood) ? "active" : "")
                          @(SecondaryMoods.Count == 2 && !SecondaryMoods.Contains(mood) ? "disabled" : "")"
                          @onclick="() => ToggleSecondaryMood(mood)">
                        @mood
                    </span>
                }
            </div>
            <p class="hint">Up to 2 moods</p>
        </div>

        <!-- CATEGORY -->
        <div class="entry-meta">
            <h4>Category</h4>
            <select class="dropdown" @bind="Category">
                @foreach (var cat in Categories)
                {
                    <option value="@cat">@cat</option>
                }
            </select>
        </div>

        <!-- TAGS -->
        <div class="entry-meta">
            <h4>Tags</h4>

            <div class="tags preset-tags">
                @foreach (var tag in PresetTags)
                {
                    <span class="pill tag @(SelectedTags.Contains(tag) ? "active" : "")"
                          @onclick="() => ToggleTag(tag)">
                        @tag
                    </span>
                }
            </div>

            <input class="tag-input"
                   placeholder="Add custom tagâ€¦"
                   @bind="CustomTag"
                   @onkeyup="HandleCustomTag" />
        </div>

        <!-- TIMESTAMPS -->
        <div class="entry-meta timestamps">
            <p>Created: @CreatedAt.ToString("dd/MM/yyyy Â· HH:mm")</p>
            <p>Updated: @UpdatedAt.ToString("dd/MM/yyyy Â· HH:mm")</p>
        </div>

    </aside>

    <!-- MAIN EDITOR -->
    <main class="editor-container">

        <div id="editor" class="editor-canvas quill-fix"></div>

        <div class="editor-actions">
            <button class="primary" @onclick="SaveEntry">
                @(IsEdit ? "Update Entry" : "Save Entry")
            </button>

            @if (IsEdit)
            {
                <button class="danger" @onclick="DeleteEntry">Delete</button>
            }
        </div>

    </main>

</div>

@code {

    /* =======================
       ROUTE / MODE
    ======================== */

    [Parameter] public int? Id { get; set; }
    private bool IsEdit => Id.HasValue;

    /* =======================
       STATE
    ======================== */

    private string _editorHtml = string.Empty;

    private string PrimaryMood = "ðŸ˜Š Happy";
    private HashSet<string> SecondaryMoods = new();

    private string Category = "Personal";

    private HashSet<string> SelectedTags = new();
    private string CustomTag = string.Empty;

    private DateTime CreatedAt = DateTime.Now;
    private DateTime UpdatedAt = DateTime.Now;

    private string TodayLabel => DateTime.Now.ToString("dddd, MMMM dd");

    /* =======================
       OPTIONS
    ======================== */

    private readonly string[] PrimaryMoodOptions =
    {
        "ðŸ˜Š Happy", "ðŸ˜Œ Calm", "ðŸ˜ Neutral", "ðŸ˜” Sad", "ðŸ˜  Angry"
    };

    private readonly string[] SecondaryMoodOptions =
    {
        "ðŸ˜´ Tired", "ðŸ˜¬ Anxious", "ðŸ¤” Thoughtful", "ðŸ˜„ Excited"
    };

    private readonly string[] Categories =
    {
        "Personal", "Work", "Health", "Relationships", "Reflection"
    };

    private readonly string[] PresetTags =
    {
        "#Work", "#Career", "#Studies", "#Family", "#Friends",
        "#Health", "#Fitness", "#Reflection", "#Writing",
        "#SelfCare", "#Travel"
    };

    /* =======================
       LIFECYCLE
    ======================== */

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;

        await _js.InvokeVoidAsync("initQuill", "editor");

        if (IsEdit)
        {
            var entry = Db.JournalEntries.FirstOrDefault(e => e.Id == Id);
            if (entry == null) return;

            PrimaryMood = entry.PrimaryMood;
            Category = entry.Category;

            SecondaryMoods = string.IsNullOrWhiteSpace(entry.SecondaryMoods)
                ? new()
                : entry.SecondaryMoods.Split(',').ToHashSet();

            SelectedTags = string.IsNullOrWhiteSpace(entry.Tags)
                ? new()
                : entry.Tags.Split(',').ToHashSet();

            CreatedAt = entry.CreatedAt;
            UpdatedAt = entry.UpdatedAt;

            await _js.InvokeVoidAsync(
                "setQuillContent", "editor", entry.ContentHtml);
        }
    }

    /* =======================
       HELPERS
    ======================== */

    private void ToggleSecondaryMood(string mood)
    {
        if (SecondaryMoods.Contains(mood))
            SecondaryMoods.Remove(mood);
        else if (SecondaryMoods.Count < 2)
            SecondaryMoods.Add(mood);
    }

    private void ToggleTag(string tag)
    {
        if (SelectedTags.Contains(tag))
            SelectedTags.Remove(tag);
        else
            SelectedTags.Add(tag);
    }

    private void HandleCustomTag(KeyboardEventArgs e)
    {
        if (e.Key != "Enter") return;

        var tag = "#" + CustomTag.Trim().Replace(" ", "");
        if (!string.IsNullOrWhiteSpace(tag))
            SelectedTags.Add(tag);

        CustomTag = string.Empty;
    }

    private void NewEntry()
    {
        Nav.NavigateTo("/journaltoday");
    }

    /* =======================
       SAVE / DELETE
    ======================== */

    private async Task SaveEntry()
    {
        try
        {
            var title = await _js.InvokeAsync<string>("getQuillTitle", "editor");
            var bodyHtml = await _js.InvokeAsync<string>("getQuillBody", "editor");

            if (string.IsNullOrWhiteSpace(bodyHtml))
            {
                await _js.InvokeVoidAsync("alert", "Journal cannot be empty.");
                return;
            }

            if (string.IsNullOrWhiteSpace(title))
                title = "Untitled Entry";

            var entry = new MoodNest.Components.Model.JournalEntry
            {
                Title = title,
                ContentHtml = bodyHtml,

                PrimaryMood = PrimaryMood,
                SecondaryMoods = string.Join(",", SecondaryMoods),
                Category = Category,
                Tags = string.Join(",", SelectedTags),

                CreatedAt = DateTime.Now,
                UpdatedAt = DateTime.Now
            };

            Db.JournalEntries.Add(entry);
            await Db.SaveChangesAsync();

            await _js.InvokeVoidAsync("showSaveSuccess");
            await _js.InvokeVoidAsync("clearQuillContent", "editor");

            SecondaryMoods.Clear();
            SelectedTags.Clear();
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex);
            await _js.InvokeVoidAsync("alert", "An error occurred while saving.");
        }
    }


    private async Task DeleteEntry()
    {
        var entry = Db.JournalEntries.FirstOrDefault(e => e.Id == Id);
        if (entry == null) return;

        Db.JournalEntries.Remove(entry);
        await Db.SaveChangesAsync();

        Nav.NavigateTo("/journal");
    }
}
