@page "/journaltoday"
@page "/journaltoday/{Id:int}"
@layout TestLayout

@inject IJSRuntime _js
@inject IJournalService JournalService
@inject NavigationManager Nav

<div class="journal-editor-page">

    <!-- LEFT META PANEL -->
    <aside class="entry-sidebar">

        <button class="new-btn"
                disabled="@HasTodayEntry"
                title="You can only write one journal entry per day"
                @onclick="NewEntry">
            Ôºã New Entry
        </button>

        <!-- TODAY -->
        <div class="entry-meta">
            <h4>Today</h4>
            <p class="meta-date">@TodayLabel</p>
        </div>

        <!-- MOODS -->
        <div class="entry-meta">
            <h4>Mood *</h4>
            <p class="hint">Select up to 3 moods (first = primary)</p>

            @foreach (var group in MoodGroups)
            {
                <p class="mood-group">@group.Key</p>

                <div class="mood-list">
                    @foreach (var mood in group.Value)
                    {
                        <span class="pill mood
                              @(IsPrimary(mood) ? "primary" : "")
                              @(IsSecondary(mood) ? "secondary" : "")
                              @(IsDisabled(mood) ? "disabled" : "")"
                              @onclick="() => ToggleMood(mood)">
                            @MoodEmojis[mood] @mood
                        </span>
                    }
                </div>
            }
        </div>

        <!-- CATEGORY -->
        <div class="entry-meta">
            <h4>Category</h4>

            <select class="dropdown" @bind="SelectedCategoryMode">
                @foreach (var cat in Categories)
                {
                    <option value="@cat">@cat</option>
                }
                <option value="__custom">Ôºã Custom category‚Ä¶</option>
            </select>

            @if (SelectedCategoryMode == "__custom")
            {
                <input class="custom-category-input"
                       placeholder="Enter custom category‚Ä¶"
                       @bind="CustomCategory"
                       @bind:event="oninput" />
            }
        </div>

        <!-- TAGS -->
        <div class="entry-meta">
            <h4>Tags</h4>

            <div class="tags preset-tags">
                @foreach (var tag in AllVisibleTags)
                {
                    <span class="pill tag @(SelectedTags.Contains(tag) ? "active" : "")"
                          @onclick="() => ToggleTag(tag)">
                        @tag
                    </span>
                }
            </div>

            <input class="tag-input"
                   placeholder="Add custom tag‚Ä¶"
                   @bind="CustomTag"
                   @onkeyup="HandleCustomTag" />
        </div>

        <!-- TIMESTAMPS -->
        <div class="entry-meta timestamps">
            <p>Created: @CreatedAt.ToString("dd/MM/yyyy ¬∑ HH:mm")</p>
            <p>Updated: @UpdatedAt.ToString("dd/MM/yyyy ¬∑ HH:mm")</p>
        </div>

    </aside>

    <!-- MAIN EDITOR -->
    <main class="editor-container">

        <div id="editor" class="editor-canvas quill-fix"></div>
        
        <div class="word-count">
            üìù @WordCount word@(WordCount == 1 ? "" : "s")
        </div>

        <div class="editor-actions">
            <button class="primary" @onclick="SaveEntry">
                @(IsEdit ? "Update Entry" : "Save Entry")
            </button>

            @if (IsEdit)
            {
                <button class="danger" @onclick="DeleteEntry">Delete</button>
            }
        </div>
        
        

    </main>

</div>

@code {

    /* =======================
       DAILY ENTRY
    ======================== */
        
    private int WordCount;

    
    private bool HasTodayEntry;

    [Parameter] public int? Id { get; set; }
    private bool IsEdit => Id.HasValue;

    /* =======================
       STATE
    ======================== */

    private List<string> SelectedMoods = new();

    private string SelectedCategoryMode = "Personal";
    private string CustomCategory = string.Empty;

    private HashSet<string> SelectedTags = new();
    private string CustomTag = string.Empty;

    private DateTime CreatedAt = DateTime.Now;
    private DateTime UpdatedAt = DateTime.Now;

    private string TodayLabel => DateTime.Now.ToString("dddd, MMMM dd");

    /* =======================
       MOODS
    ======================== */

    private readonly Dictionary<string, string[]> MoodGroups = new()
    {
        ["Positive"] = new[] { "Happy", "Excited", "Relaxed", "Grateful", "Confident" },
        ["Neutral"]  = new[] { "Calm", "Thoughtful", "Curious", "Nostalgic", "Bored" },
        ["Negative"] = new[] { "Sad", "Angry", "Stressed", "Lonely", "Anxious" }
    };

    private readonly Dictionary<string, string> MoodEmojis = new()
    {
        ["Happy"] = "üòä",
        ["Excited"] = "ü§©",
        ["Relaxed"] = "üòå",
        ["Grateful"] = "üôè",
        ["Confident"] = "üí™",

        ["Calm"] = "üòê",
        ["Thoughtful"] = "ü§î",
        ["Curious"] = "üßê",
        ["Nostalgic"] = "üï∞",
        ["Bored"] = "üò∂",

        ["Sad"] = "üòî",
        ["Angry"] = "üò†",
        ["Stressed"] = "üò´",
        ["Lonely"] = "üòû",
        ["Anxious"] = "üò¨"
    };

    /* =======================
       CATEGORIES
    ======================== */

    private readonly string[] Categories =
    {
        "Personal", "Work", "Health", "Relationships", "Reflection"
    };

    /* =======================
       TAGS
    ======================== */

    private readonly string[] PresetTags =
    {
        "#Work", "#Career", "#Studies", "#Family", "#Friends", "#Relationships",
        "#Health", "#Fitness", "#PersonalGrowth", "#SelfCare", "#Hobbies", "#Travel",
        "#Nature", "#Finance", "#Spirituality", "#Birthday", "#Holiday", "#Vacation",
        "#Celebration", "#Exercise", "#Reading", "#Writing", "#Cooking", "#Meditation",
        "#Yoga", "#Music", "#Shopping", "#Parenting", "#Projects", "#Planning", "#Reflection"
    };

    private IEnumerable<string> AllVisibleTags =>
        PresetTags.Concat(SelectedTags).Distinct().OrderBy(t => t);

    /* =======================
       LIFECYCLE
    ======================== */

    protected override async Task OnInitializedAsync()
    {
        if (IsEdit) return;

        var todayResult = await JournalService.GetTodayAsync();
        if (todayResult.Success && todayResult.Data != null)
        {
            HasTodayEntry = true;
            Nav.NavigateTo($"/journaltoday/{todayResult.Data.Id}", replace: true);
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;

        // Initialize Quill
        await _js.InvokeVoidAsync("initQuill", "editor");

        // üîπ Register live word counter (NEW ‚Äì safe addition)
        var dotNetRef = DotNetObjectReference.Create(this);
        await _js.InvokeVoidAsync(
            "registerQuillWordCounter",
            "editor",
            dotNetRef
        );

        if (!IsEdit) return;

        var result = await JournalService.GetByIdAsync(Id!.Value);
        if (!result.Success || result.Data == null) return;

        var model = result.Data;

        // Load moods
        SelectedMoods.Clear();
        SelectedMoods.Add(model.PrimaryMood);

        if (!string.IsNullOrWhiteSpace(model.SecondaryMoods))
            SelectedMoods.AddRange(model.SecondaryMoods.Split(','));

        // Load tags
        SelectedTags = string.IsNullOrWhiteSpace(model.Tags)
            ? new()
            : model.Tags.Split(',').ToHashSet();

        // Metadata
        CreatedAt = model.CreatedAt;
        UpdatedAt = model.UpdatedAt;

        // Category
        SelectedCategoryMode = Categories.Contains(model.Category)
            ? model.Category
            : "__custom";

        CustomCategory = SelectedCategoryMode == "__custom"
            ? model.Category
            : string.Empty;

        // Set editor content
        await _js.InvokeVoidAsync(
            "setQuillContent",
            "editor",
            model.Title,
            model.ContentHtml
        );

        // üîπ Initialize word count for existing entry (NEW)
        WordCount = await _js.InvokeAsync<int>(
            "getQuillWordCount",
            "editor"
        );
    }


    /* =======================
       HELPERS
    ======================== */

    private void ToggleMood(string mood)
    {
        if (SelectedMoods.Contains(mood))
        {
            SelectedMoods.Remove(mood);
            return;
        }

        if (SelectedMoods.Count < 3)
            SelectedMoods.Add(mood);
    }

    private bool IsPrimary(string mood) =>
        SelectedMoods.Count > 0 && SelectedMoods[0] == mood;

    private bool IsSecondary(string mood) =>
        SelectedMoods.Skip(1).Contains(mood);

    private bool IsDisabled(string mood) =>
        SelectedMoods.Count == 3 && !SelectedMoods.Contains(mood);

    private void ToggleTag(string tag)
    {
        if (SelectedTags.Contains(tag))
            SelectedTags.Remove(tag);
        else
            SelectedTags.Add(tag);
    }

    private void HandleCustomTag(KeyboardEventArgs e)
    {
        if (e.Key != "Enter") return;

        var cleaned = CustomTag.Trim().Replace(" ", "");
        if (string.IsNullOrWhiteSpace(cleaned)) return;

        SelectedTags.Add("#" + cleaned);
        CustomTag = string.Empty;
    }

    private void NewEntry() =>
        Nav.NavigateTo("/journaltoday", true);

    /* =======================
       SAVE / DELETE
    ======================== */

    private async Task SaveEntry()
    {
        var title = await _js.InvokeAsync<string>("getQuillTitle", "editor");
        var bodyHtml = await _js.InvokeAsync<string>("getQuillBody", "editor");

        if (string.IsNullOrWhiteSpace(bodyHtml))
        {
            await _js.InvokeVoidAsync("alert", "Journal cannot be empty.");
            return;
        }

        if (!SelectedMoods.Any())
        {
            await _js.InvokeVoidAsync("alert", "Please select at least one mood.");
            return;
        }

        var resolvedCategory =
            SelectedCategoryMode == "__custom"
                ? CustomCategory.Trim()
                : SelectedCategoryMode;

        if (string.IsNullOrWhiteSpace(resolvedCategory))
        {
            await _js.InvokeVoidAsync("alert", "Please enter a category.");
            return;
        }

        if (!IsEdit)
        {
            var todayCheck = await JournalService.GetTodayAsync();
            if (todayCheck.Success && todayCheck.Data != null)
            {
                await _js.InvokeVoidAsync("alert", "You already have a journal entry for today.");
                return;
            }
        }

        var model = new JournalEntryViewModel
        {
            Title = string.IsNullOrWhiteSpace(title) ? "Untitled Entry" : title,
            ContentHtml = bodyHtml,
            PrimaryMood = SelectedMoods[0],
            SecondaryMoods = string.Join(",", SelectedMoods.Skip(1)),
            Category = resolvedCategory,
            Tags = string.Join(",", SelectedTags)
        };

        var result = IsEdit
            ? await JournalService.UpdateAsync(Id!.Value, model)
            : await JournalService.CreateAsync(model);

        if (!result.Success)
        {
            await _js.InvokeVoidAsync("alert", result.ErrorMessage);
            return;
        }

        UpdatedAt = DateTime.Now;

        await _js.InvokeVoidAsync("showSaveSuccess");
        await _js.InvokeVoidAsync("clearQuillContent", "editor");

        SelectedMoods.Clear();
        SelectedTags.Clear();

        if (!IsEdit)
            Nav.NavigateTo("/journal");
    }

    private async Task DeleteEntry()
    {
        if (!Id.HasValue) return;

        var result = await JournalService.DeleteAsync(Id.Value);
        if (!result.Success) return;

        Nav.NavigateTo("/journal");
    }
    
    [JSInvokable]
    public void UpdateWordCount(int count)
    {
        WordCount = count;
        InvokeAsync(StateHasChanged);
    }

}
