@page "/journaltoday"
@layout TestLayout
@inject IJSRuntime _js
@inject MoodNest.Data.AppDbContext Db

<div class="journal-editor-page">

    <!-- LEFT META PANEL -->
    <aside class="entry-sidebar">

        <button class="new-btn">Ôºã New Entry</button>

        <!-- TODAY -->
        <div class="entry-meta">
            <h4>Today</h4>
            <p class="meta-date">@TodayLabel</p>
        </div>

        <!-- PRIMARY MOOD -->
        <div class="entry-meta">
            <h4>Primary Mood *</h4>
            <div class="mood-list">
                @foreach (var mood in PrimaryMoodOptions)
                {
                    <span class="pill mood
                            @(PrimaryMood == mood ? "active" : "")"
                          @onclick="() => PrimaryMood = mood">
                        @mood
                    </span>

                }
            </div>
        </div>

        <!-- SECONDARY MOODS -->
        <div class="entry-meta">
            <h4>Secondary Moods</h4>
            <div class="mood-list subtle">
                @foreach (var mood in SecondaryMoodOptions)
                {
                    <span class="pill mood
                          @(SecondaryMoods.Contains(mood) ? "active" : "")
                          @(SecondaryMoods.Count == 2 && !SecondaryMoods.Contains(mood) ? "disabled" : "")"
                          @onclick="() => ToggleSecondaryMood(mood)">
                        @mood
                    </span>


                }
            </div>
            <p class="hint">Up to 2 moods</p>
        </div>

        <!-- CATEGORY -->
        <div class="entry-meta">
            <h4>Category</h4>
            <select class="dropdown" @bind="Category">
                @foreach (var cat in Categories)
                {
                    <option value="@cat">@cat</option>
                }
            </select>
        </div>

        <!-- TAGS -->
        <div class="entry-meta">
            <h4>Tags</h4>

            <div class="tags preset-tags">
                @foreach (var tag in PresetTags)
                {
                    <span class="pill tag
                            @(SelectedTags.Contains(tag) ? "active" : "")"
                          @onclick="() => ToggleTag(tag)">
                        @tag
                    </span>

                }
            </div>
            <!-- CUSTOM TAGS -->
            <input class="tag-input"
                   placeholder="Add custom tag‚Ä¶"
                   @bind="CustomTag"
                   @onkeyup="HandleCustomTag" />



        </div>

        <!-- TIMESTAMPS -->
        <div class="entry-meta timestamps">
            <p>Created: @CreatedAt.ToString("dd/MM/yyyy ¬∑ HH:mm")</p>
            <p>Updated: @UpdatedAt.ToString("dd/MM/yyyy ¬∑ HH:mm")</p>
        </div>

    </aside>

    <!-- MAIN EDITOR -->
    <main class="editor-container">

        <div id="editor" class="editor-canvas quill-fix"></div>

        <div class="editor-actions">
            <button class="primary" @onclick="SaveEntry">Save Entry</button>
            <button class="danger">Delete</button>
        </div>

    </main>

</div>

@code {

    /* =======================
       STATE
    ======================== */

    private string _editorHtml = string.Empty;

    private string PrimaryMood = "Happy";
    private HashSet<string> SecondaryMoods = new();

    private string Category = "Personal";

    private HashSet<string> SelectedTags = new();
    private string CustomTag = string.Empty;

    private DateTime CreatedAt = DateTime.Now;
    private DateTime UpdatedAt = DateTime.Now;

    private string TodayLabel => DateTime.Now.ToString("dddd, MMMM dd");

    /* =======================
       OPTIONS
    ======================== */

    private readonly string[] PrimaryMoodOptions =
    {
        "üòä Happy", "üòå Calm", "üòê Neutral", "üòî Sad", "üò† Angry"
    };

    private readonly string[] SecondaryMoodOptions =
    {
        "üò¥ Tired", "üò¨ Anxious", "ü§î Thoughtful", "üòÑ Excited"
    };

    private readonly string[] Categories =
    {
        "Personal", "Work", "Health", "Relationships", "Reflection"
    };

    private readonly string[] PresetTags =
    {
        "#Work", "#Career", "#Studies", "#Family", "#Friends",
        "#Health", "#Fitness", "#Reflection", "#Writing",
        "#SelfCare", "#Travel"
    };

    /* =======================
       LIFECYCLE
    ======================== */

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;

        // Initialize Quill
        await _js.InvokeVoidAsync("initQuill", "editor");

        // üîç TEMP DEBUG CHECK ‚Äî remove after testing
        var exists = await _js.InvokeAsync<string>(
            "eval",
            "typeof window.getQuillText"
        );

        Console.WriteLine($"getQuillText exists: {exists}");
    }


    

    /* =======================
       HELPERS
    ======================== */

    private void ToggleSecondaryMood(string mood)
    {
        if (SecondaryMoods.Contains(mood))
            SecondaryMoods.Remove(mood);
        else if (SecondaryMoods.Count < 2)
            SecondaryMoods.Add(mood);
    }

    private void ToggleTag(string tag)
    {
        if (SelectedTags.Contains(tag))
            SelectedTags.Remove(tag);
        else
            SelectedTags.Add(tag);
    }

    private void HandleCustomTag(KeyboardEventArgs e)
    {
        if (e.Key != "Enter")
            return;

        if (string.IsNullOrWhiteSpace(CustomTag))
            return;

        // Normalize the tag
        var tag = "#" + CustomTag.Trim().Replace(" ", "");

        // Prevent duplicates
        if (!SelectedTags.Contains(tag))
        {
            SelectedTags.Add(tag);
        }

        // Clear input
        CustomTag = string.Empty;
    }



    /* =======================
       SAVE
    ======================== */

    private async Task SaveEntry()
    {
        try
        {
            var plainText = await _js.InvokeAsync<string>("getQuillText", "editor");
            if (string.IsNullOrWhiteSpace(plainText))
            {
                await _js.InvokeVoidAsync("alert", "Journal cannot be empty.");
                return;
            }

            // üîπ Extract title
            var title = await _js.InvokeAsync<string>("getQuillTitle", "editor");
            if (string.IsNullOrWhiteSpace(title))
                title = "Untitled Entry";

            var html = await _js.InvokeAsync<string>("getQuillContent", "editor");

            var entry = new MoodNest.Components.Model.JournalEntry
            {
                Title = title,                 // ‚úÖ THIS WAS MISSING / NOT EXECUTING
                ContentHtml = html,

                PrimaryMood = PrimaryMood,
                SecondaryMoods = string.Join(",", SecondaryMoods),
                Category = Category,
                Tags = string.Join(",", SelectedTags),

                CreatedAt = DateTime.Now,
                UpdatedAt = DateTime.Now
            };

            Db.JournalEntries.Add(entry);
            await Db.SaveChangesAsync();

            await _js.InvokeVoidAsync("showSaveSuccess");
            await _js.InvokeVoidAsync("clearQuillContent", "editor");

            SecondaryMoods.Clear();
            SelectedTags.Clear();
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex);
            await _js.InvokeVoidAsync("alert", "An error occurred while saving.");
        }
    }



}
