@page "/journal"
@layout TestLayout

@inject IJournalService JournalService
@inject IJournalFilterService JournalFilterService
@inject NavigationManager Nav

<div class="journal-list-page">

    <div class="list-header">
        <div>
            <h2>Journal Entries</h2>
            <p class="subtitle">Browse and revisit your past reflections</p>
        </div>
        <span class="sort-indicator">
            Sorted by <strong>Latest first</strong>
        </span>
    </div>

    <!-- ===============================
         FILTER BAR
         =============================== -->

    <div class="filters">

        <!-- SEARCH -->
        <input class="search-input"
               placeholder="Search title or content…"
               @bind-value="Filter.SearchText"
               @bind-value:event="oninput"
               @bind-value:after="OnSearchChanged" />

        <!-- DATE RANGE -->
        <div class="date-range">
            <label class="date-label">
                <span>From</span>
                <input type="date"
                       @bind="Filter.FromDate"
                       @bind:after="OnDateChanged" />
            </label>

            <span class="date-separator">→</span>

            <label class="date-label">
                <span>To</span>
                <input type="date"
                       @bind="Filter.ToDate"
                       @bind:after="OnDateChanged" />
            </label>
        </div>

        <!-- MOOD -->
        <select @bind="SelectedMood" @bind:after="OnMoodChanged">
            <option value="">All moods</option>
            <option>Happy</option>
            <option>Calm</option>
            <option>Sad</option>
            <option>Angry</option>
            <option>Tired</option>
            <option>Anxious</option>
            <option>Thoughtful</option>
            <option>Excited</option>
        </select>

        <!-- TAG -->
        <input class="tag-input"
               placeholder="Filter by tag (#work)"
               @bind-value="SelectedTag"
               @bind-value:event="oninput"
               @bind-value:after="OnTagChanged" />

        <button class="reset-btn" @onclick="ResetFilters">
            Reset
        </button>

    </div>

    <!-- ===============================
         JOURNAL LIST
         =============================== -->

    <div class="timeline">

        @if (!Entries.Any())
        {
            <p>No journal entries found.</p>
        }
        else
        {
            @foreach (var entry in Entries)
            {
                <div class="timeline-entry">

                    <div class="timeline-main clickable"
                         @onclick="() => OpenEntry(entry.Id)">

                        <div class="timeline-date">
                            <span class="day">@entry.Day</span>
                            <span class="month">@entry.Month</span>
                        </div>

                        <div class="timeline-content">
                            <h4>@entry.Title</h4>
                        </div>

                        <div class="timeline-info">

                            <div class="pill primary">
                                @entry.PrimaryMood
                            </div>

                            @if (!string.IsNullOrWhiteSpace(entry.SecondaryMoods))
                            {
                                <div class="secondary-moods">
                                    @foreach (var mood in entry.SecondaryMoods.Split(','))
                                    {
                                        <span class="pill">@mood</span>
                                    }
                                </div>
                            }

                            <div class="meta-line">
                                <span class="category">@entry.Category</span>

                                @if (!string.IsNullOrWhiteSpace(entry.Tags))
                                {
                                    @foreach (var tag in entry.Tags.Split(','))
                                    {
                                        <span class="tag">@tag</span>
                                    }
                                }
                            </div>

                        </div>
                    </div>

                    <div class="timeline-actions">
                        <button class="edit-btn" @onclick="() => EditEntry(entry.Id)">
                            Edit
                        </button>
                        <button class="delete-btn" @onclick="() => DeleteEntry(entry.Id)">
                            Delete
                        </button>
                    </div>
                </div>
            }
        }

    </div>

    <!-- ===============================
         PAGINATION
         =============================== -->

    @if (TotalPages > 1)
    {
        <div class="pagination">
            <button class="page-btn"
                    disabled="@(CurrentPage == 1)"
                    @onclick="PrevPage">
                ‹ Prev
            </button>

            <span class="page-indicator">
                Page <strong>@CurrentPage</strong> of <strong>@TotalPages</strong>
            </span>

            <button class="page-btn"
                    disabled="@(CurrentPage == TotalPages)"
                    @onclick="NextPage">
                Next ›
            </button>
        </div>
    }

</div>

@code {

    /* =======================
       DATA
    ======================== */

    private List<JournalEntryDisplayModel> Entries = new();
    private List<JournalEntryDisplayModel> FilteredEntries = new();

    private JournalFilterModel Filter = new();

    private string SelectedMood = string.Empty;
    private string SelectedTag = string.Empty;

    /* =======================
       PAGINATION
    ======================== */

    private const int PageSize = 5;
    private int CurrentPage = 1;
    private int TotalPages = 1;

    /* =======================
       LIFECYCLE
    ======================== */

    protected override async Task OnInitializedAsync()
    {
        await ApplyFilters(resetPage: true);
    }

    /* =======================
       FILTER WRAPPERS (IMPORTANT)
    ======================== */

    private async Task OnSearchChanged()
        => await ApplyFilters(resetPage: true);

    private async Task OnDateChanged()
        => await ApplyFilters(resetPage: true);

    private async Task OnMoodChanged()
    {
        Filter.Moods.Clear();

        if (!string.IsNullOrWhiteSpace(SelectedMood))
            Filter.Moods.Add(SelectedMood);

        await ApplyFilters(resetPage: true);
    }

    private async Task OnTagChanged()
    {
        Filter.Tags.Clear();

        if (!string.IsNullOrWhiteSpace(SelectedTag))
            Filter.Tags.Add(SelectedTag);

        await ApplyFilters(resetPage: true);
    }

    private async Task ResetFilters()
    {
        Filter = new JournalFilterModel();
        SelectedMood = string.Empty;
        SelectedTag = string.Empty;

        await ApplyFilters(resetPage: true);
    }

    /* =======================
       CORE FILTER LOGIC
    ======================== */

    private async Task ApplyFilters(bool resetPage = false)
    {
        var result = await JournalFilterService.GetFilteredAsync(Filter);

        FilteredEntries = result.Success
            ? result.Data
            : new();

        if (resetPage)
            CurrentPage = 1;

        TotalPages = Math.Max(
            1,
            (int)Math.Ceiling(FilteredEntries.Count / (double)PageSize)
        );

        CurrentPage = Math.Min(CurrentPage, TotalPages);

        Entries = FilteredEntries
            .Skip((CurrentPage - 1) * PageSize)
            .Take(PageSize)
            .ToList();
    }

    /* =======================
       PAGINATION ACTIONS
    ======================== */

    private async Task NextPage()
    {
        if (CurrentPage < TotalPages)
        {
            CurrentPage++;
            await ApplyFilters();
        }
    }

    private async Task PrevPage()
    {
        if (CurrentPage > 1)
        {
            CurrentPage--;
            await ApplyFilters();
        }
    }

    /* =======================
       NAVIGATION / ACTIONS
    ======================== */

    private void OpenEntry(int id)
        => Nav.NavigateTo($"/journal/{id}");

    private void EditEntry(int id)
        => Nav.NavigateTo($"/journaltoday/{id}");

    private async Task DeleteEntry(int id)
    {
        var result = await JournalService.DeleteAsync(id);
        if (!result.Success) return;

        FilteredEntries.RemoveAll(e => e.Id == id);
        await ApplyFilters();
    }
}
