@page "/"
@layout TestLayout
@inject NavigationManager Nav
@inject MoodNest.Components.Services.PinAuthService Auth

<div class="lock-screen">

    <div class="lock-card">

        <span class="lock-badge">Secure Access</span>

        <h1>Unlock Your Journal</h1>

        <p class="lock-subtitle">
            Your journal is private. Enter your credentials to continue.
        </p>

        <!-- Username / Email -->
        <input class="text-input"
               placeholder="Username or Email"
               autofocus
               @bind="identifier"
               @bind:event="oninput" />

        <!-- PIN -->
        <input type="password"
               maxlength="4"
               class="pin-input"
               placeholder="● ● ● ●"
               @bind="enteredPin"
               @bind:event="oninput" />

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="error-message">
                @errorMessage
            </div>
        }

        <button class="unlock-btn" @onclick="VerifyPin">
            Unlock
        </button>

        <p class="register-link">
            New here?
            <a @onclick="GoToRegister">Create an account</a>
        </p>

        <p class="lock-hint">
            Too many failed attempts will temporarily lock access.
        </p>

    </div>

</div>

@code {
    private string identifier = string.Empty; // username or email
    private string enteredPin = string.Empty;
    private string errorMessage = string.Empty;

    protected override void OnInitialized()
    {
        Auth.Lock(); // always start locked
    }

    private async Task VerifyPin()
    {
        if (string.IsNullOrWhiteSpace(identifier) || string.IsNullOrWhiteSpace(enteredPin))
        {
            errorMessage = "Please enter your username/email and PIN.";
            return;
        }

        if (Auth.VerifyPin(identifier, enteredPin))
        {
            errorMessage = string.Empty;
            identifier = string.Empty;
            enteredPin = string.Empty;

            await Task.Yield();
            Nav.NavigateTo("/test", replace: true);
        }
        else
        {
            errorMessage = "Invalid credentials. Please try again.";
            enteredPin = string.Empty;
        }
    }

    private void GoToRegister()
    {
        identifier = string.Empty;
        enteredPin = string.Empty;
        errorMessage = string.Empty;

        Nav.NavigateTo("/register");
    }
}
