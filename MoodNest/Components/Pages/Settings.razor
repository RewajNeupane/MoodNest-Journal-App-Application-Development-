@page "/settings"
@layout TestLayout

@inject PinAuthService Auth
@inject JournalPdfExportService PdfService
@inject IJournalService JournalService

<!-- ===============================
     SETTINGS PAGE
     =============================== -->

<div class="settings-page">

    <!-- PAGE HEADER -->
    <div class="settings-header">
        <h2>Settings</h2>
        <p class="subtitle">Customize your experience & manage your data</p>
    </div>

    <!-- ===============================
         PROFILE SETTINGS
         =============================== -->
    <section class="settings-card">
        <h3>Profile</h3>

        <div class="security-grid">

            <!-- USERNAME -->
            <div class="security-field">
                <label>Username</label>
                <input @bind="Username" />
            </div>

            <!-- EMAIL -->
            <div class="security-field">
                <label>Email</label>
                <input type="email" @bind="Email" />
            </div>

            <!-- SAVE PROFILE -->
            <button class="primary-btn" @onclick="SaveProfile">
                Save Changes
            </button>
        </div>

        <!-- PROFILE FEEDBACK MESSAGE -->
        @if (!string.IsNullOrEmpty(profileMessage))
        {
            <p class="security-hint">@profileMessage</p>
        }
    </section>

    <!-- ===============================
         SECURITY / PIN SETTINGS
         =============================== -->
    <section class="settings-card">
        <h3>Security</h3>

        <div class="security-grid">

            <!-- CURRENT PIN -->
            <div class="security-field">
                <label>Current PIN</label>
                <input type="password" maxlength="4" @bind="currentPin" />
            </div>

            <!-- NEW PIN -->
            <div class="security-field">
                <label>New PIN</label>
                <input type="password" maxlength="4" @bind="newPin" />
            </div>

            <!-- CHANGE PIN -->
            <button class="primary-btn" @onclick="ChangePin">
                Change PIN
            </button>
        </div>

        <!-- PIN FEEDBACK MESSAGE -->
        @if (!string.IsNullOrEmpty(pinMessage))
        {
            <p class="security-hint">@pinMessage</p>
        }
    </section>

    <!-- ===============================
         EXPORT SETTINGS
         =============================== -->
    <section class="settings-card">
        <h3>Export Journals</h3>

        <div class="export-grid">

            <!-- DATE RANGE: FROM -->
            <div class="export-field">
                <label>From</label>
                <input type="date" @bind="ExportFrom" />
            </div>

            <!-- DATE RANGE: TO -->
            <div class="export-field">
                <label>To</label>
                <input type="date" @bind="ExportTo" />
            </div>

            <!-- EXPORT BUTTON -->
            <button class="export-btn" @onclick="ExportPdf">
                Export as PDF
            </button>
        </div>

        <!-- EXPORT FEEDBACK MESSAGE -->
        @if (!string.IsNullOrEmpty(exportMessage))
        {
            <p class="export-hint">@exportMessage</p>
        }
    </section>

</div>

@code {

    /* =======================
       PROFILE STATE
       ======================== */

    /// <summary>
    /// Editable username field.
    /// </summary>
    private string Username = "";

    /// <summary>
    /// Editable email field.
    /// </summary>
    private string Email = "";

    /// <summary>
    /// Feedback message for profile updates.
    /// </summary>
    private string? profileMessage;

    /// <summary>
    /// Initializes profile data from the authenticated user.
    /// </summary>
    protected override void OnInitialized()
    {
        var user = Auth.GetCurrentUser();
        if (user == null) return;

        Username = user.Username;
        Email = user.Email;
    }

    /// <summary>
    /// Saves updated profile information via the authentication service.
    /// </summary>
    private void SaveProfile()
    {
        if (string.IsNullOrWhiteSpace(Username) ||
            string.IsNullOrWhiteSpace(Email))
        {
            profileMessage = "Username and email are required.";
            return;
        }

        if (Auth.UpdateProfile(Username, Email))
            profileMessage = "Profile updated successfully.";
        else
            profileMessage = "Failed to update profile.";
    }

    /* =======================
       PIN MANAGEMENT
       ======================== */

    /// <summary>
    /// Current PIN entered by the user.
    /// </summary>
    private string currentPin = "";

    /// <summary>
    /// New PIN to replace the existing one.
    /// </summary>
    private string newPin = "";

    /// <summary>
    /// Feedback message for PIN changes.
    /// </summary>
    private string? pinMessage;

    /// <summary>
    /// Updates the user's PIN after validation.
    /// </summary>
    private void ChangePin()
    {
        if (newPin.Length != 4)
        {
            pinMessage = "PIN must be exactly 4 digits.";
            return;
        }

        if (Auth.ChangePin(currentPin, newPin))
        {
            pinMessage = "PIN updated successfully.";
            currentPin = "";
            newPin = "";
        }
        else
        {
            pinMessage = "Current PIN is incorrect.";
        }
    }

    /* =======================
       EXPORT FUNCTIONALITY
       ======================== */

    /// <summary>
    /// Start date for journal export.
    /// </summary>
    private DateTime? ExportFrom;

    /// <summary>
    /// End date for journal export.
    /// </summary>
    private DateTime? ExportTo;

    /// <summary>
    /// Feedback message for export operations.
    /// </summary>
    private string? exportMessage;

    /// <summary>
    /// Exports journal entries within the selected date range as a PDF.
    /// </summary>
    private async Task ExportPdf()
    {
        if (!ExportFrom.HasValue || !ExportTo.HasValue)
        {
            exportMessage = "Please select a date range.";
            return;
        }

        var entries = await JournalService
            .GetEntriesBetweenAsync(ExportFrom.Value, ExportTo.Value);

        if (!entries.Any())
        {
            exportMessage = "No entries found in this range.";
            return;
        }

        var path = await PdfService.ExportAsync(
            entries,
            ExportFrom.Value,
            ExportTo.Value
        );

        exportMessage = $"PDF exported successfully:\n{path}";
    }
}
