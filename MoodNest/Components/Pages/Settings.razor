@page "/settings"
@layout TestLayout

@inject MoodNest.Components.Services.PinAuthService Auth
@inject JournalPdfExportService PdfService
@inject IJournalService JournalService

<div class="settings-page">

    <!-- HEADER -->
    <div class="settings-header">
        <h2>Settings</h2>
        <p class="subtitle">Customize your experience & manage your data</p>
    </div>

    <!-- ===============================
         SECURITY / CHANGE PIN
         =============================== -->

    <section class="settings-card">
        <h3>Security</h3>

        <p class="setting-desc">
            Update your access PIN to keep your journal private.
        </p>

        <div class="security-grid">
            <div class="security-field">
                <label>Current PIN</label>
                <input type="password" maxlength="4" @bind="currentPin" />
            </div>

            <div class="security-field">
                <label>New PIN</label>
                <input type="password" maxlength="4" @bind="newPin" />
            </div>

            <button class="primary-btn" @onclick="ChangePin">
                Change PIN
            </button>
        </div>

        @if (!string.IsNullOrEmpty(pinMessage))
        {
            <p class="security-hint">@pinMessage</p>
        }
    </section>

    <!-- ===============================
         EXPORT JOURNALS
         =============================== -->

    <section class="settings-card">
        <h3>Export Journals</h3>

        <div class="export-grid">
            <div class="export-field">
                <label>From</label>
                <input type="date" @bind="ExportFrom" />
            </div>

            <div class="export-field">
                <label>To</label>
                <input type="date" @bind="ExportTo" />
            </div>

            <button class="export-btn" @onclick="ExportPdf">
                Export as PDF
            </button>
        </div>

        @if (!string.IsNullOrEmpty(exportMessage))
        {
            <p class="export-hint">@exportMessage</p>
        }
    </section>

</div>

@code {

    /* =======================
       EXPORT
    ======================== */

    private DateTime? ExportFrom;
    private DateTime? ExportTo;
    private string? exportMessage;

    private async Task ExportPdf()
    {
        if (!ExportFrom.HasValue || !ExportTo.HasValue)
        {
            exportMessage = "Please select a valid date range.";
            return;
        }

        var entries = await JournalService
            .GetEntriesBetweenAsync(ExportFrom.Value, ExportTo.Value);

        if (entries.Count == 0)
        {
            exportMessage = "No journal entries found in this range.";
            return;
        }

        // âœ… CORRECT async call
        var path = await PdfService.ExportAsync(
            entries,
            ExportFrom.Value,
            ExportTo.Value
        );

        exportMessage = $"PDF exported successfully:\n{path}";
    }

    /* =======================
       SECURITY
    ======================== */

    private string currentPin = string.Empty;
    private string newPin = string.Empty;
    private string? pinMessage;

    private void ChangePin()
    {
        if (newPin.Length != 4)
        {
            pinMessage = "PIN must be exactly 4 digits.";
            return;
        }

        if (Auth.ChangePin(currentPin, newPin))
        {
            pinMessage = "PIN updated successfully.";
            currentPin = "";
            newPin = "";
        }
        else
        {
            pinMessage = "Current PIN is incorrect.";
        }
    }
}
