@page "/settings"
@layout TestLayout

@inject PinAuthService Auth
@inject JournalPdfExportService PdfService
@inject IJournalService JournalService

<div class="settings-page">

    <div class="settings-header">
        <h2>Settings</h2>
        <p class="subtitle">Customize your experience & manage your data</p>
    </div>

    <!-- ===============================
         PROFILE
         =============================== -->

    <section class="settings-card">
        <h3>Profile</h3>

        <div class="security-grid">
            <div class="security-field">
                <label>Username</label>
                <input @bind="Username" />
            </div>

            <div class="security-field">
                <label>Email</label>
                <input type="email" @bind="Email" />
            </div>

            <button class="primary-btn" @onclick="SaveProfile">
                Save Changes
            </button>
        </div>

        @if (!string.IsNullOrEmpty(profileMessage))
        {
            <p class="security-hint">@profileMessage</p>
        }
    </section>

    <!-- ===============================
         SECURITY / PIN
         =============================== -->

    <section class="settings-card">
        <h3>Security</h3>

        <div class="security-grid">
            <div class="security-field">
                <label>Current PIN</label>
                <input type="password" maxlength="4" @bind="currentPin" />
            </div>

            <div class="security-field">
                <label>New PIN</label>
                <input type="password" maxlength="4" @bind="newPin" />
            </div>

            <button class="primary-btn" @onclick="ChangePin">
                Change PIN
            </button>
        </div>

        @if (!string.IsNullOrEmpty(pinMessage))
        {
            <p class="security-hint">@pinMessage</p>
        }
    </section>

    <!-- ===============================
         EXPORT
         =============================== -->

    <section class="settings-card">
        <h3>Export Journals</h3>

        <div class="export-grid">
            <div class="export-field">
                <label>From</label>
                <input type="date" @bind="ExportFrom" />
            </div>

            <div class="export-field">
                <label>To</label>
                <input type="date" @bind="ExportTo" />
            </div>

            <button class="export-btn" @onclick="ExportPdf">
                Export as PDF
            </button>
        </div>

        @if (!string.IsNullOrEmpty(exportMessage))
        {
            <p class="export-hint">@exportMessage</p>
        }
    </section>

</div>

@code {

    /* =======================
       PROFILE
    ======================== */

    private string Username = "";
    private string Email = "";
    private string? profileMessage;

    protected override void OnInitialized()
    {
        var user = Auth.GetCurrentUser();
        if (user == null) return;

        Username = user.Username;
        Email = user.Email;
    }

    private void SaveProfile()
    {
        if (string.IsNullOrWhiteSpace(Username) ||
            string.IsNullOrWhiteSpace(Email))
        {
            profileMessage = "Username and email are required.";
            return;
        }

        if (Auth.UpdateProfile(Username, Email))
            profileMessage = "Profile updated successfully.";
        else
            profileMessage = "Failed to update profile.";
    }

    /* =======================
       PIN
    ======================== */

    private string currentPin = "";
    private string newPin = "";
    private string? pinMessage;

    private void ChangePin()
    {
        if (newPin.Length != 4)
        {
            pinMessage = "PIN must be exactly 4 digits.";
            return;
        }

        if (Auth.ChangePin(currentPin, newPin))
        {
            pinMessage = "PIN updated successfully.";
            currentPin = "";
            newPin = "";
        }
        else
        {
            pinMessage = "Current PIN is incorrect.";
        }
    }

    /* =======================
       EXPORT
    ======================== */

    private DateTime? ExportFrom;
    private DateTime? ExportTo;
    private string? exportMessage;

    private async Task ExportPdf()
    {
        if (!ExportFrom.HasValue || !ExportTo.HasValue)
        {
            exportMessage = "Please select a date range.";
            return;
        }

        var entries = await JournalService
            .GetEntriesBetweenAsync(ExportFrom.Value, ExportTo.Value);

        if (!entries.Any())
        {
            exportMessage = "No entries found in this range.";
            return;
        }

        var path = await PdfService.ExportAsync(
            entries,
            ExportFrom.Value,
            ExportTo.Value
        );

        exportMessage = $"PDF exported successfully:\n{path}";
    }
}
