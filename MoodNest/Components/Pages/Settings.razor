@page "/settings"
@layout TestLayout
@inject MoodNest.Components.Services.PinAuthService Auth
@inject IJSRuntime JS

<div class="settings-page">

    <!-- HEADER -->
    <div class="settings-header">
        <h2>Settings</h2>
        <p class="subtitle">Customize your experience & manage your data</p>
    </div>

    <!-- ===============================
         SECURITY / CHANGE PIN
         =============================== -->

    <section class="settings-card">
        <h3>Security</h3>

        <p class="setting-desc" style="margin-bottom:18px">
            Update your access PIN to keep your journal private.
        </p>

        <div class="security-grid">
            <div class="security-field">
                <label>Current PIN</label>
                <input type="password"
                       maxlength="4"
                       placeholder="••••"
                       @bind="currentPin" />
            </div>

            <div class="security-field">
                <label>New PIN</label>
                <input type="password"
                       maxlength="4"
                       placeholder="••••"
                       @bind="newPin" />
            </div>

            <button class="primary-btn" @onclick="ChangePin">
                Change PIN
            </button>
        </div>

        @if (!string.IsNullOrEmpty(pinMessage))
        {
            <p class="security-hint">@pinMessage</p>
        }
    </section>

    <!-- ===============================
         EXPORT JOURNALS
         =============================== -->

    <section class="settings-card">
        <h3>Export Journals</h3>

        <div class="export-grid">
            <div class="export-field">
                <label>From</label>
                <input type="date" @bind="ExportFrom" />
            </div>

            <div class="export-field">
                <label>To</label>
                <input type="date" @bind="ExportTo" />
            </div>

            <button class="export-btn" @onclick="ExportPdf">
                Export as PDF
            </button>
        </div>

        <p class="export-hint">
            Exports all journal entries within the selected date range.
        </p>
    </section>

</div>

@code {

    /* =======================
       EXPORT
    ======================== */

    private DateTime? ExportFrom;
    private DateTime? ExportTo;

    private async Task ExportPdf()
    {
        if (!ExportFrom.HasValue || !ExportTo.HasValue)
        {
            await JS.InvokeVoidAsync("alert", "Please select a date range.");
            return;
        }

        await JS.InvokeVoidAsync(
            "alert",
            $"Exporting journals from {ExportFrom:dd MMM yyyy} to {ExportTo:dd MMM yyyy}"
        );
    }

    /* =======================
       SECURITY
    ======================== */

    private string currentPin = string.Empty;
    private string newPin = string.Empty;
    private string? pinMessage;

    private void ChangePin()
    {
        if (newPin.Length != 4)
        {
            pinMessage = "PIN must be exactly 4 digits.";
            return;
        }

        if (Auth.ChangePin(currentPin, newPin))
        {
            pinMessage = "PIN updated successfully.";
            currentPin = "";
            newPin = "";
        }
        else
        {
            pinMessage = "Current PIN is incorrect.";
        }
    }
}
